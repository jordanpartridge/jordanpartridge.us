<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\Http;

class CreateBotIssue extends Command
{
    protected $signature = 'issues:create-as-bot 
                            {title : Issue title}
                            {body : Issue body}
                            {--labels= : Comma-separated labels}';

    protected $description = 'Create GitHub issue using a bot account or GitHub App';

    public function handle()
    {
        $title = $this->argument('title');
        $body = $this->argument('body');
        $labels = $this->option('labels') ? explode(',', $this->option('labels')) : [];

        // Option 1: Use GitHub App (if configured)
        if (config('services.github.app_token')) {
            return $this->createIssueWithApp($title, $body, $labels);
        }

        // Option 2: Use Personal Access Token for bot account
        if (config('services.github.bot_token')) {
            return $this->createIssueWithBotToken($title, $body, $labels);
        }

        // Option 3: Create with attribution to indicate automation
        return $this->createIssueWithAttribution($title, $body, $labels);
    }

    protected function createIssueWithApp(string $title, string $body, array $labels): int
    {
        $this->info('Creating issue with GitHub App...');

        $response = Http::withHeaders([
            'Authorization' => 'Bearer ' . config('services.github.app_token'),
            'Accept'        => 'application/vnd.github.v3+json',
            'User-Agent'    => 'Laravel-Log-Analyzer-Bot',
        ])->post('https://api.github.com/repos/' . config('services.github.repository') . '/issues', [
            'title'  => $title,
            'body'   => $body . "\n\n---\n*Created automatically by Laravel Log Analyzer Bot*",
            'labels' => $labels,
        ]);

        if ($response->successful()) {
            $issue = $response->json();
            $this->info("✅ Issue created: " . $issue['html_url']);
            return Command::SUCCESS;
        }

        $this->error("❌ Failed to create issue: " . $response->body());
        return Command::FAILURE;
    }

    protected function createIssueWithBotToken(string $title, string $body, array $labels): int
    {
        $this->info('Creating issue with bot account...');

        // Similar to above but with bot token
        $response = Http::withHeaders([
            'Authorization' => 'token ' . config('services.github.bot_token'),
            'Accept'        => 'application/vnd.github.v3+json',
            'User-Agent'    => 'Laravel-Log-Analyzer-Bot',
        ])->post('https://api.github.com/repos/' . config('services.github.repository') . '/issues', [
            'title'  => $title,
            'body'   => $body . "\n\n---\n*Created by @laravel-log-bot*",
            'labels' => $labels,
        ]);

        if ($response->successful()) {
            $issue = $response->json();
            $this->info("✅ Issue created: " . $issue['html_url']);
            return Command::SUCCESS;
        }

        $this->error("❌ Failed to create issue: " . $response->body());
        return Command::FAILURE;
    }

    protected function createIssueWithAttribution(string $title, string $body, array $labels): int
    {
        $this->info('Creating issue with automation attribution...');

        // Modify the body to clearly indicate it's automated
        $automatedBody = "🤖 **Automated Issue Report**\n\n" . $body;
        $automatedBody .= "\n\n---\n";
        $automatedBody .= "*This issue was automatically generated by Claude Code log analysis*\n";
        $automatedBody .= "*Timestamp: " . now()->toDateTimeString() . "*\n";
        $automatedBody .= "*Generated by: Laravel Log Analyzer*";

        // Use gh CLI but with clear automation markers
        $command = [
            'gh', 'issue', 'create',
            '--title', '🤖 [AUTO] ' . $title,
            '--body', $automatedBody
        ];

        // Only add labels if they were provided
        if (!empty($labels)) {
            $command[] = '--label';
            $command[] = implode(',', $labels);
        }

        $result = \Illuminate\Support\Facades\Process::run($command);

        if ($result->successful()) {
            $this->info("✅ Issue created: " . trim($result->output()));
            return Command::SUCCESS;
        }

        $this->error("❌ Failed to create issue: " . $result->errorOutput());
        return Command::FAILURE;
    }
}
